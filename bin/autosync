#!/usr/bin/env ruby
require 'trollop'

# Setup options
opts = Trollop::options do
  opt :dir, "Directory to watch", :type => String, :required => true 
  opt :verbose, "Show verbose output", :default => false
  opt :frequency, "Frequency to run", :default => 10
  opt :growl, "Remote growl notifications [alpha]", :type => String 
end

verbose = "Git sync started..."
puts verbose if opts[:verbose]
%x(ssh #{opts[:growl]} 'growl -m "#{verbose}" -t "Gitsync"') if opts[:growl]

dir = opts[:dir]

while true
  curr = %x(du -s #{dir} | awk '{print $1}').chomp
  prev = curr

  while curr == prev
    #puts "No change, waiting #{opts[:frequency]} seconds" if opts[:verbose]
    sleep opts[:frequency].to_i
    curr = %x(du -s #{dir} | awk '{print $1}').chomp
  end

  sleep 1
  orig = %x(du -s #{dir} | awk '{print $1}').chomp
  showmsg = true
  while curr != orig
    verbose = "Waiting for transfer to finsih..."
    puts verbose if opts[:verbose] && showmsg
    %x(ssh #{opts[:growl]} 'growl -m "#{verbose}" -t "Gitsync"') if opts[:growl] && showmsg
    showmsg = false
    
    orig = %x(du -s #{dir} | awk '{print $1}').chomp
    sleep 4
    curr = %x(du -s #{dir} | awk '{print $1}').chomp
  end
  
  msg = `cd #{dir} && git status --porcelain`
  
  verbose = msg
  puts verbose if opts[:verbose]
  %x(ssh #{opts[:growl]} 'growl -m "#{verbose}" -t "Adding Files"') if opts[:growl]
  
  %x(cd #{dir} && git add -A)
  %x(cd #{dir} && git commit -qm "#{msg}")

  verbose = "#{msg} commited."
  puts verbose if opts[:verbose]
  %x(ssh #{opts[:growl]} 'growl -m "#{verbose}" -t "Files Commited"') if opts[:growl]
  
  puts "Watching for change..." if opts[:verbose]
end